#!/usr/bin/make -f

STRIP =strip
ifneq (,$(findstring nostrip,$(DEB_BUILD_OPTIONS)))
  STRIP =: nostrip
endif

CFLAGS =-O2 -Wall
LDFLAGS =-s -Os -pipe
CC =gcc
ifneq (,$(findstring diet,$(DEB_BUILD_OPTIONS)))
  CC =diet -v -Os gcc
endif

DIR =`pwd`/debian/ipsvd

build: deb-checkdir build-stamp
build-stamp:
	tar xzpf ipsvd-0.8.1.tar.gz
	-gcc -v
	( cd net/ipsvd-0.8.1/src && \
	ln -s ipsvd-0.8.1 ipsvd && mv ipsvd ../.. && \
	echo "$(CC) $(CFLAGS)" >conf-cc && \
	echo "$(CC) $(LDFLAGS)" >conf-ld && \
	$(MAKE) )
	touch build-stamp

clean: deb-checkdir deb-checkuid
	rm -rf net
	rm -f build-stamp
	rm -rf "$(DIR)"
	rm -f debian/files debian/substvars changelog

install: deb-checkdir deb-checkuid build-stamp
	rm -rf "$(DIR)"
	# programs
	install -d -m0755 "$(DIR)"/usr/bin
	for i in tcpsvd udpsvd ipsvd-cdb; do \
	  install -m0755 net/ipsvd/src/$$i "$(DIR)"/usr/bin/ || exit 1; \
	done
	$(STRIP) -R .comment -R .note "$(DIR)"/usr/bin/*
	# man pages
	for i in 5 7 8; do \
	  install -d -m0755 "$(DIR)"/usr/share/man/man$$i && \
	  for j in net/ipsvd/man/*.$$i; do \
	    install -m0644 $$j "$(DIR)"/usr/share/man/man$$i/ || exit 1; \
	  done || exit 1; \
	done
	gzip -9 "$(DIR)"/usr/share/man/man?/*.?
	# changelog
	rm -f changelog && ln -s net/ipsvd/package/CHANGES changelog

binary-indep:

binary-arch: install ipsvd.deb
	test "$(CC)" != 'gcc' || dpkg-shlibdeps "$(DIR)"/usr/bin/*
	dpkg-gencontrol -isp -pipsvd -P"$(DIR)"
	dpkg -b "$(DIR)" ..

binary: binary-indep binary-arch
.PHONY: build clean install binary-indep binary-arch binary

include debian/implicit
